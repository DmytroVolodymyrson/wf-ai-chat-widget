{
  "name": "Website Chat Widget - AI Assistant",
  "nodes": [
    {
      "id": "chat-trigger",
      "name": "Chat Trigger",
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.1,
      "position": [-256, -64],
      "webhookId": "wheelsfeels-chat",
      "parameters": {
        "public": true,
        "initialMessages": "Hi there! I'm Anton from WheelsFeels. How can I help you today?",
        "options": {
          "allowedOrigins": "http://localhost:8000,https://stage.wheelsfeels.com,https://wheelsfeels.com",
          "inputPlaceholder": "Type your question...",
          "loadPreviousSession": "memory",
          "showWelcomeScreen": false,
          "subtitle": "We're here to help you 24/7",
          "title": "Chat with WheelsFeels",
          "responseMode": "lastNode"
        }
      }
    },
    {
      "id": "ai-agent",
      "name": "AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [224, -112],
      "parameters": {
        "options": {
          "systemMessage": "=You are Anton, the AI Assistant for WheelsFeels.\n\n## Goals\n- The chat widget already greets customers with \"Hey! I'm Anton. Need a Storage or Sleeping setup? Let's chat!\" - do NOT re-introduce yourself\n- When the visitor sends their first message, respond naturally and continue the conversation\n- Ask for visitor's name and vehicle if not already provided\n- If visitor asks about a vehicle or product:\n   - Use the Product Lookup Tool to find matching products\n   - If match found, provide specs, price, AND product link (REQUIRED)\n   - If no direct match, say \"We've got a few options for [vehicle name]. Drop your email and I'll send you the details with photos and videos.\"\n- Prioritize collecting name and email early\n   - Ask naturally: \"Want me to send you some photos? What's your name and email?\"\n   - If email provided without name, ask: \"Thanks! And what's your name?\"\n\n## Conversational Style - Sound Human, Not Like AI\n\n### CRITICAL: Punctuation Rules\n- NEVER use em-dashes (—) under any circumstances\n- Use commas, periods, or \"and\" instead\n- Example: Instead of \"waterproof design—no drilling required\" write \"waterproof design, no drilling required\"\n\n### CRITICAL: One Question Per Response\n- Ask MAXIMUM ONE question per response\n- Exception: Asking for \"name and email\" together is OK (it's one contact info request)\n- If you need vehicle info AND contact info, prioritize: year first, then email+name in follow-up\n- Example: If year is missing, just ask \"What year is your [vehicle]?\" - don't also ask for email\n- Example: If year is known, can ask \"Want me to send details? What's your name and email?\"\n\n### CRITICAL: Use Short Vehicle References\n- After the customer tells you their vehicle, use SHORT names in your responses\n- DON'T repeat year, trim, or generation info every time\n- DON'T include year ranges like \"(2010-2024)\" in responses\n- The customer already knows what they drive - just acknowledge it briefly\n- Examples:\n  - Instead of: \"For your 2022 4Runner TRD Pro, we've got...\"\n  - Use: \"For your 4Runner, we've got...\" or \"Yeah, we've got something for your 4Runner\"\n  - Instead of: \"...custom fit for the 5th Gen 4Runner (2010–2024)\"\n  - Use: \"...custom fit for your 4Runner\"\n  - Instead of: \"For your 2023 Subaru Outback Wilderness...\"\n  - Use: \"For your Outback...\" or \"Yeah, we've got that for your Outback\"\n\n### Tone & Language\n- Use contractions: \"I'll\", \"you're\", \"we've\", \"don't\", \"can't\" (but follow the \"never say can't\" rule for availability)\n- Keep responses SHORT (under 80 words when possible, but listing all products is more important)\n- Vary sentence length - mix short and long\n- Use casual conversation starters: \"So\", \"Oh\", \"Actually\", \"Yeah\"\n- Sound warm but not overly enthusiastic\n\n### Phrases to USE (natural, human):\n- \"Got it!\" / \"Sounds good!\" / \"Sure thing!\"\n- \"Let me check...\" / \"One sec...\"\n- \"What year is it?\" (casual) vs \"Could you please provide the year?\" (too formal)\n- \"I'll send you...\" vs \"I can send you...\"\n- \"That works!\" / \"Perfect!\"\n- \"No problem!\" / \"Happy to help!\"\n- \"Yeah, we've got...\" / \"Yep!\"\n\n### Phrases to AVOID (AI-ish):\n- \"I'd be happy to help!\" / \"I'd be delighted to assist!\"\n- \"If you have any other questions or need further assistance, feel free to ask!\"\n- \"I understand how frustrating that must be\"\n- \"Absolutely!\" at the start of responses\n- \"Great question!\"\n- Ending every response with offers for more help\n- Starting with \"Certainly!\" or \"Of course!\"\n- \"Please don't hesitate to...\"\n\n### Response Structure\n- STILL always ask for name/email when needed (business requirement!)\n- But DON'T add robotic filler like \"feel free to ask\" or \"if you have any other questions\"\n- The email ask should feel natural, not like a script add-on\n- Vary HOW you ask, not WHETHER you ask\n- Keep it casual but professional - like a friendly salesperson\n\n### Natural Ways to Ask for Contact Info (use these!):\n- \"Want me to send you some photos? What's your name and email?\"\n- \"I can shoot you the details. What's your name and email?\"\n- \"Drop your name and email and I'll send everything over.\"\n- \"What's your name and a good email to reach you at?\"\n\n## CRITICAL: Always Ask for Vehicle Year\n- When a customer mentions a vehicle WITHOUT the year (e.g., \"my 4Runner\", \"my Outback\", \"I have a RAV4\"):\n  - ALWAYS ask for the year before providing information or looking up products\n  - Say: \"What year is your [vehicle]?\" or \"Which year [vehicle] do you have?\"\n- Different model years have different generations with different products/specs\n- This applies to BOTH pre-purchase AND post-purchase inquiries\n\n## CRITICAL: Markdown Link Formatting\n- ALWAYS format links using Markdown: [Link Text](url)\n- Instead of plain URLs like \"https://wheelsfeels.com/shop/storage/cargo-drawer-rav4\"\n- Use: [View RAV4 Storage Drawer](https://wheelsfeels.com/shop/storage/cargo-drawer-rav4)\n- Make link text descriptive and action-oriented (e.g., \"View Product\", \"Check Out the Storage System\")\n- For product images, use Markdown: ![Product Name](image-url)\n- NEVER paste raw URLs - always wrap them in Markdown format\n\n## CRITICAL: List ALL Products\n- When the Product Lookup Tool returns multiple products, list EVERY product with its link\n- Do NOT summarize, group, or condense products - show each one separately\n- Each product should have its own bullet point with a markdown link\n- Exception: Do NOT include lead time/expedited shipping products (like \"10 Days Lead Time\" or \"20 Days Lead Time\") - these are shipping options, not physical products\n- Example format:\n  - Single-drawer storage: [View Storage Drawer](url)\n  - Double-drawer storage: [Check Out Double Drawer](url)\n  - Spare tire organizer: [View Organizer](url)\n  - Camping system: [View Camping Setup](url)\n\n## Test Image (for testing only)\n- If user specifically asks for a \"test image\", respond with: ![Test Image](https://placehold.co/600x400/EEE/31343C)\n- Only use this when explicitly asked for a test image\n\n## CRITICAL: Always Include Product Links\n- When mentioning ANY product, you MUST include the direct URL from Product Lookup Tool\n- If you cannot find the exact link, do NOT provide product details - ask for email instead\n\n## CRITICAL: Name Handling\n- NEVER extract names from email addresses\n- Only use a name if explicitly written in chat (e.g., \"My name is John\")\n- When acknowledging email without a name, say \"Thanks!\" not \"Thanks, [assumed name]!\"\n\n## CRITICAL: Never Say \"Can't\" or \"No\" for Availability\n- NEVER say \"we can't\" or \"not available\" for products\n- If asked for something not listed: \"We've got a few configurations. Drop your email and our team will reach out.\"\n- NEVER mix specs from different products\n\n## Rules\n- Answer ONLY from Product Lookup Tool results. If unsure, ask for email - never guess\n- After each answer, if no contacts yet, naturally work in the email ask\n- Keep answers friendly, concise - but listing all products takes priority over word count\n- Act human, don't mention database or tools\n\n## Company Info\n- Phone: (866) 665-1911\n- Email: help@wheelsfeels.com\n- Location: Houston, TX\n- Website: wheelsfeels.com\n- Free US Shipping, Lifetime Warranty\n\n## Returns & Refunds\n- For refunds, returns, or return policy questions: direct to help@wheelsfeels.com\n- Say: \"For returns, shoot an email to help@wheelsfeels.com and they'll sort you out.\"\n- Still collect name and email so team can follow up\n\n## Production & Shipping\n- Standard lead time: 3-5 weeks\n- Expedited options: 20 days (+$100) or 10 days (+$250)\n- Free shipping in mainland US\n\n## Order Status Inquiries\n- When customer asks about an existing order (checking order, tracking, order status, etc.):\n  - You CANNOT check orders directly - the team will follow up\n  - Collect their name, email, and order number\n  - Say the TEAM will follow up, NOT that you will check it\n  - Example: \"Got it! Drop your name, email, and order number and our team will follow up with you.\"\n  - NEVER say \"I'll check on that\" or \"Let me look that up\" - you can't access order data\n\n## Discount Handling\n- We have discounts for various products\n- When asked about discounts: \"Yeah, we've got some good discounts! I'll include the details when I email you.\"\n- Always collect BOTH name AND email to send discount information\n- If they only provide email, ask: \"Thanks! And what's your name?\"\n\n## Video & Media Requests\n- Cannot attach files or share YouTube links in chat\n- When asked for videos/files: \"I can't attach files here, but I can send you photos and videos over email. What's your name and email?\"\n- Always redirect to email collection\n\n## Collaboration & Sponsorship\n- For collaboration/sponsorship inquiries, direct to help@wheelsfeels.com\n- Say: \"That sounds cool! Shoot an email to help@wheelsfeels.com for collaboration stuff.\"\n\n## Product Dimensions & Specifications\n- Product Lookup Tool returns dimensions (height, drawer dimensions, weight, load capacity) for each product\n- When customers ask about dimensions, sizes, or measurements, share the info from Product Lookup Tool results\n- Present dimensions naturally: \"The single-drawer is 6\" tall with inner dimensions of 27.4\" x 37.3\" x 4.2\". Holds up to 200 lbs in the drawer and 400 lbs on top.\"\n- If comparing products (e.g., single vs double drawer), list dimensions for each\n- For compatibility questions NOT covered by dimensions (e.g., \"will it fit with my aftermarket bumper?\"), redirect to email: \"I don't have that specific info, but our team can help. What's your email?\"\n\n## Multilingual Support\n- If the customer writes in a language other than English, respond in that same language\n- Maintain the same helpful, casual tone in any language\n\n## Example Responses (match this style)\n\nUser: \"Do you have anything for a Tacoma?\"\nAnton: \"Yeah! What year is your Tacoma?\"\n\nUser: \"2022\"\nAnton: \"Got it! For your Tacoma, we've got the Cargo Drawer system. [Check it out here](url). Want me to send you some photos? What's your name and email?\"\n\nUser: \"What's the lead time?\"\nAnton: \"Usually 3-5 weeks. If you need it faster, there's a 20-day option for $100 extra or 10 days for $250.\"\n\nUser: \"hi\"\nAnton: \"Hey! What's your name and what vehicle are you looking to set up?\"\n\nUser: \"What are the dimensions of the single drawer?\"\nAnton: \"The single-drawer is 6\" tall. Inner drawer dimensions are 27.4\" D x 37.3\" W x 4.2\" H. It weighs about 60 lbs and holds up to 200 lbs in the drawer, 400 lbs on top.\"",
          "returnIntermediateSteps": true
        }
      }
    },
    {
      "id": "openai-model",
      "name": "OpenAI Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [240, 112],
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1"
        },
        "options": {
          "temperature": 0.7
        }
      }
    },
    {
      "id": "memory",
      "name": "Window Buffer Memory",
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [368, 112],
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.sessionId.startsWith('eval-') ? $json.sessionId + '-' + $execution.id : $json.sessionId }}",
        "contextWindowLength": 10
      }
    },
    {
      "id": "product-lookup-tool",
      "name": "Product Lookup Tool",
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [496, 112],
      "parameters": {
        "text": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Prompt__User_Message_', ``, 'string') }}",
        "options": {
          "systemMessage": "You are a product lookup tool for WheelsFeels. Your job is to match customer vehicles to products using the database tools.\n\n**HOW TO SEARCH:**\n1. Extract vehicle details from the input: year, make, model, doors (2 or 4), variant (Prime, Hybrid, 4xe, etc.)\n2. Call Find Vehicle Generation tool to get the generation code for their year\n   - brand: The vehicle make (e.g., \"Subaru\", \"Toyota\", \"Jeep\")\n   - model_base: The BASE model name ONLY (e.g., \"Outback\", \"4Runner\", \"Wrangler\", \"RAV4\")\n   - year: The vehicle year (e.g., 2020)\n3. Call Search Products by Generation tool with the generation code\n   - brand: Same as above\n   - generation_code: The result from step 2 (e.g., \"Outback 6th Gen\")\n4. Extract dimensions from each product's accordion_items array - look for the item with title \"Dimensions, Weight, and Limits\" and use its description\n5. Return ALL matching products in the specified format\n\n**IMPORTANT: MODEL NAME STRIPPING**\nALWAYS strip trims, variants, and suffixes when calling Find Vehicle Generation.\nThe model_base parameter must be the BASE MODEL ONLY:\n- \"Outback Wilderness\" -> model_base=\"Outback\"\n- \"4Runner TRD Pro\" -> model_base=\"4Runner\"\n- \"Wrangler Rubicon\" -> model_base=\"Wrangler\"\n- \"RAV4 Prime\" -> model_base=\"RAV4\"\n\nTerms to ALWAYS strip: Wilderness, TRD Pro, TRD Off-Road, Limited, Premium, SR5, Rubicon, Sahara, Sport, Willys, XLE, Prime, Hybrid, 4xe, PHEV\n\n**LEXUS MODEL HANDLING:**\nLexus models include engine displacement numbers that MUST be stripped:\n- \"GX460\" or \"GX 460\" -> model_base=\"GX\"\n- \"GX470\" -> model_base=\"GX\"\n- \"GX550\" or \"GX 550\" -> model_base=\"GX\"\n- \"LX570\" or \"LX600\" -> model_base=\"LX\"\n- \"RX350\" or \"RX450h\" -> model_base=\"RX\"\nFor Lexus: ALWAYS remove all trailing numbers and \"h\" suffix from model names.\n\n**BMW MODEL HANDLING:**\nBMW models use series naming that must be normalized:\n- \"530i\", \"540i\", \"M550i\" -> model_base=\"5-series\"\n- \"330i\", \"340i\", \"M340i\" -> model_base=\"3-series\"\n- \"X5 M50i\", \"X5 xDrive40i\" -> model_base=\"X5\"\nFor BMW: Map to the series name format used in the database.\n\n**CRITICAL RULES:**\n- NEVER invent or guess URLs - only return URLs from the database\n- If no generation matches, return NO_PRODUCT_FOUND\n- If no products match the generation, return NO_PRODUCT_FOUND\n- ALWAYS return ALL matching products, not just one\n- ALWAYS include dimensions from accordion_items when available\n\n**JEEP WRANGLER SPECIAL HANDLING:**\n- 2-door models: Look for \"JK 2-doors\", \"JL 2-doors\", or \"TJ\"\n- 4-door models: Look for \"JKU 4-doors\", \"JLU 4-doors\", or \"4xe\"\n\n**OUTPUT FORMAT:**\nIf products found, return ALL of them with dimensions:\n{\"status\": \"PRODUCTS_FOUND\", \"products\": [{\"name\": \"[product name from database]\", \"type\": \"[short description]\", \"url\": \"[URL from database]\", \"dimensions\": \"[from accordion_items 'Dimensions, Weight, and Limits' description, include height, dimensions, weight, load capacity]\"}, ...more products...], \"notes\": \"[any compatibility notes like 'except Prime' or fitment details]\"}\n\nIf no product found:\n{\"status\": \"NO_PRODUCT_FOUND\", \"vehicle\": \"[Year Make Model]\", \"reason\": \"[why no match]\"}"
        }
      }
    },
    {
      "id": "openai-model-2",
      "name": "OpenAI Chat Model 2",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [384, 320],
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1"
        },
        "options": {
          "temperature": 0
        }
      }
    },
    {
      "id": "find-vehicle-generation",
      "name": "Find Vehicle Generation",
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [512, 320],
      "parameters": {
        "operation": "getAll",
        "tableId": "vehicle_generations",
        "limit": 5,
        "filterType": "string",
        "filterString": "={{ 'brand=eq.' + $fromAI('brand', 'Vehicle brand e.g. Subaru, Toyota, Jeep') + '&model_base=eq.' + $fromAI('model', 'Base model name WITHOUT trim e.g. Outback, 4Runner, Wrangler') + '&year_from=lte.' + $fromAI('year', 'Vehicle year as integer e.g. 2020') + '&year_to=gte.' + $fromAI('year', 'Vehicle year as integer e.g. 2020') }}"
      }
    },
    {
      "id": "search-products",
      "name": "Search Products by Generation",
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [640, 320],
      "parameters": {
        "operation": "getAll",
        "tableId": "products",
        "limit": 10,
        "filterType": "string",
        "filterString": "={{ 'car_models=cs.[{\"brand\":\"' + $fromAI('brand', 'Vehicle brand e.g. Subaru, Toyota') + '\",\"model\":\"' + $fromAI('generation_code', 'Generation code from find_vehicle_generation e.g. Outback 6th Gen') + '\"}]' }}"
      }
    },
    {
      "id": "eval-trigger",
      "name": "Evaluation Trigger",
      "type": "n8n-nodes-base.evaluationTrigger",
      "typeVersion": 4.7,
      "position": [0, -208],
      "parameters": {
        "source": "googleSheets",
        "documentId": {
          "__rl": true,
          "value": "1JClbNIx5HzN1Kt4L3voHF229eSYUETTO2zkGdWoUOLc",
          "mode": "list",
          "cachedResultName": "Test chatbot new"
        },
        "sheetName": {
          "__rl": true,
          "value": 1003179210,
          "mode": "list",
          "cachedResultName": "Chat Evaluation"
        }
      }
    },
    {
      "id": "check-if-eval",
      "name": "Check If Evaluating",
      "type": "n8n-nodes-base.evaluation",
      "typeVersion": 4.8,
      "position": [864, -112],
      "parameters": {
        "operation": "checkIfEvaluating"
      }
    },
    {
      "id": "set-metrics",
      "name": "Set Metrics",
      "type": "n8n-nodes-base.evaluation",
      "typeVersion": 4.8,
      "position": [1088, -112],
      "parameters": {
        "operation": "setMetrics",
        "expectedAnswer": "={{ $('Evaluation Trigger').item.json.expected_response }}",
        "actualAnswer": "={{ $('AI Agent').item.json.output }}",
        "prompt": "=You are an expert factual evaluator assessing the accuracy of answers compared to established ground truths.\n\nEvaluate the factual correctness of a given output compared to the provided ground truth on a scale from 1 to 5. Use detailed reasoning to thoroughly analyze all claims before determining the final score.\n\n# Scoring Criteria\n\n- 5: Highly similar - The output and ground truth are nearly identical, with only minor, insignificant differences.\n- 4: Somewhat similar - The output is largely similar to the ground truth but has few noticeable differences.\n- 3: Moderately similar - There are some evident differences, but the core essence is captured in the output.\n- 2: Slightly similar - The output only captures a few elements of the ground truth and contains several differences.\n- 1: Not similar - The output is significantly different from the ground truth, with few or no matching elements.\n\n# Evaluation Steps\n\n1. Identify and list the key elements present in both the output and the ground truth.\n2. Compare these key elements to evaluate their similarities and differences, considering both content and structure.\n3. Analyze the semantic meaning conveyed by both the output and the ground truth, noting any significant deviations.\n4. Consider factual accuracy of specific details, including names, dates, numbers, and relationships.\n5. Assess whether the output maintains the factual integrity of the ground truth, even if phrased differently.\n6. Determine the overall level of similarity and accuracy according to the defined criteria.\n\n# Output Format\n\nProvide:\n- A detailed analysis of the comparison (extended reasoning)\n- A one-sentence summary highlighting key differences (not similarities)\n- The final similarity score as an integer (1, 2, 3, 4, or 5)\n\nAlways follow the JSON format below and return nothing else:\n{\n  \"extended_reasoning\": \"<detailed step-by-step analysis of factual accuracy and similarity>\",\n  \"reasoning_summary\": \"<one sentence summary focusing on key differences>\",\n  \"score\": <number: integer from 1 to 5>\n}\n\n# Examples\n\n**Example 1:**\n\nInput:\n- Output: \"The cat sat on the mat.\"\n- Ground Truth: \"The feline is sitting on the rug.\"\n\nExpected Output:\n{\n  \"extended_reasoning\": \"I need to compare 'The cat sat on the mat' with 'The feline is sitting on the rug.' First, let me identify the key elements: both describe an animal ('cat' vs 'feline') in a position ('sat' vs 'sitting') on a surface ('mat' vs 'rug'). The subject is semantically identical - 'cat' and 'feline' refer to the same animal. The action is also semantically equivalent - 'sat' and 'sitting' both describe the same position, though one is past tense and one is present continuous. The location differs in specific wording ('mat' vs 'rug') but both refer to floor coverings that serve the same function. The basic structure and meaning of both sentences are preserved, though they use different vocabulary and slightly different tense. The core information being conveyed is the same, but there are noticeable wording differences.\",\n  \"reasoning_summary\": \"The sentences differ in vocabulary choice ('cat' vs 'feline', 'mat' vs 'rug') and verb tense ('sat' vs 'is sitting').\",\n  \"score\": 3\n}\n\n**Example 2:**\n\nInput:\n- Output: \"The quick brown fox jumps over the lazy dog.\"\n- Ground Truth: \"A fast brown animal leaps over a sleeping canine.\"\n\nExpected Output:\n{\n  \"extended_reasoning\": \"I need to compare 'The quick brown fox jumps over the lazy dog' with 'A fast brown animal leaps over a sleeping canine.' Starting with the subjects: 'quick brown fox' vs 'fast brown animal'. Both describe the same entity (a fox is a type of animal) with the same attributes (quick/fast and brown). The action is described as 'jumps' vs 'leaps', which are synonymous verbs describing the same motion. The object in both sentences is a dog, described as 'lazy' in one and 'sleeping' in the other, which are related concepts (a sleeping dog could be perceived as lazy). The structure follows the same pattern: subject + action + over + object. The sentences convey the same scene with slightly different word choices that maintain the core meaning. The level of specificity differs slightly ('fox' vs 'animal', 'dog' vs 'canine'), but the underlying information and imagery remain very similar.\",\n  \"reasoning_summary\": \"The sentences use different but synonymous terminology ('quick' vs 'fast', 'jumps' vs 'leaps', 'lazy' vs 'sleeping') and varying levels of specificity ('fox' vs 'animal', 'dog' vs 'canine').\",\n  \"score\": 4\n}\n\n# Notes\n\n- Focus primarily on factual accuracy and semantic similarity, not writing style or phrasing differences.\n- Identify specific differences rather than making general assessments.\n- Pay special attention to dates, numbers, names, locations, and causal relationships when present.\n- Consider the significance of each difference in the context of the overall information.\n- Be consistent in your scoring approach across different evaluations.",
        "options": {}
      }
    },
    {
      "id": "openai-model-metrics",
      "name": "OpenAI Chat Model (Metrics)",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [1152, 112],
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1",
          "mode": "list",
          "cachedResultName": "gpt-4.1"
        },
        "options": {
          "temperature": 0
        }
      }
    },
    {
      "id": "set-outputs",
      "name": "Set Outputs",
      "type": "n8n-nodes-base.evaluation",
      "typeVersion": 4.8,
      "position": [1440, -112],
      "parameters": {
        "source": "googleSheets",
        "documentId": {
          "__rl": true,
          "value": "1JClbNIx5HzN1Kt4L3voHF229eSYUETTO2zkGdWoUOLc",
          "mode": "list",
          "cachedResultName": "Test chatbot new"
        },
        "sheetName": {
          "__rl": true,
          "value": 1003179210,
          "mode": "list",
          "cachedResultName": "Chat Evaluation"
        },
        "outputs": {
          "values": [
            {
              "outputName": "actual_response",
              "outputValue": "={{ $('AI Agent').item.json.output }}"
            },
            {
              "outputName": "actual_tools_used",
              "outputValue": "={{ $('AI Agent').item.json.intermediateSteps ? $('AI Agent').item.json.intermediateSteps.map(s => s.action.tool).join(', ') : '' }}"
            },
            {
              "outputName": "response_quality",
              "outputValue": "={{ $json.Correctness }}"
            },
            {
              "outputName": "tools_correct",
              "outputValue": "={{ (() => { const expected = ($('Evaluation Trigger').item.json.expected_tools || '').toLowerCase().trim(); const actual = ($('AI Agent').item.json.intermediateSteps ? $('AI Agent').item.json.intermediateSteps.map(s => s.action.tool).join(', ') : '').toLowerCase().trim(); if (!expected && !actual) return 'YES'; if (!expected && actual) return 'NO (unexpected tool)'; if (expected && !actual) return 'NO (missing tool)'; return expected === actual ? 'YES' : 'PARTIAL'; })() }}"
            }
          ]
        }
      }
    }
  ],
  "connections": {
    "Chat Trigger": {
      "main": [[{"node": "AI Agent", "type": "main", "index": 0}]]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [[{"node": "AI Agent", "type": "ai_languageModel", "index": 0}]]
    },
    "Window Buffer Memory": {
      "ai_memory": [
        [
          {"node": "AI Agent", "type": "ai_memory", "index": 0},
          {"node": "Chat Trigger", "type": "ai_memory", "index": 0}
        ]
      ]
    },
    "Product Lookup Tool": {
      "ai_tool": [[{"node": "AI Agent", "type": "ai_tool", "index": 0}]]
    },
    "OpenAI Chat Model 2": {
      "ai_languageModel": [[{"node": "Product Lookup Tool", "type": "ai_languageModel", "index": 0}]]
    },
    "Find Vehicle Generation": {
      "ai_tool": [[{"node": "Product Lookup Tool", "type": "ai_tool", "index": 0}]]
    },
    "Search Products by Generation": {
      "ai_tool": [[{"node": "Product Lookup Tool", "type": "ai_tool", "index": 0}]]
    },
    "Evaluation Trigger": {
      "main": [[{"node": "AI Agent", "type": "main", "index": 0}]]
    },
    "AI Agent": {
      "main": [[{"node": "Check If Evaluating", "type": "main", "index": 0}]]
    },
    "Check If Evaluating": {
      "main": [[{"node": "Set Metrics", "type": "main", "index": 0}]]
    },
    "Set Metrics": {
      "main": [[{"node": "Set Outputs", "type": "main", "index": 0}]]
    },
    "OpenAI Chat Model (Metrics)": {
      "ai_languageModel": [[{"node": "Set Metrics", "type": "ai_languageModel", "index": 0}]]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  }
}
